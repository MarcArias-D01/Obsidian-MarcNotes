# Auditoría y análisis de actividad en AWS con **CloudTrail**, **Athena** y automatización con **EventBridge**

## Introducción
Esta sesión repasa conceptos de observabilidad y se centra en **monitorizar la cuenta de AWS** (no la infraestructura interna) usando **AWS CloudTrail**. Se cubren tipos de eventos, retención, costes, opciones de almacenamiento (**S3** vs **CloudTrail Lake**) y consulta de logs con **Amazon Athena**. Finalmente, se propone un laboratorio práctico para **detectar actividad anómala** provocada por un contenedor y **notificar eventos** mediante **EventBridge**.

## Lista de punto
- Diferencia entre **monitorización** y **observabilidad** (repaso) y recordatorio de **CloudWatch**
- Qué es **AWS CloudTrail** y qué registra (llamadas a la API)
- Tipos de eventos en CloudTrail: **Management events** vs **Data events**Retención por defecto y creación de un **Trail**\n- Almacenamiento y análisis:\n - CloudTrail → **S3** (logs JSON comprimidos)\n - CloudTrail → **CloudTrail Lake** (formato columnar)\n - Consultas con **Amazon Athena** sobre S3\n- Servicio adicional: **CloudTrail Insights** (detección de anomalías)\n- Introducción a **AWS Config** (gobernanza y cumplimiento)\n- Concepto de **trazas** en microservicios y *instrumentación* (avance)\n- Laboratorio: auditoría de una “API de gatitos” y automatización de alertas hacia **Slack** con webhooks\n\n## Puntos clave 1 — Repaso de CloudWatch (contexto de observabilidad)\n- Se repasó la diferencia:\n - **Monitorización**: *qué está pasando* (métricas/alertas).\n - **Observabilidad**: *por qué pasa* (contexto, correlación, trazas/logs).\n- Recordatorio de CloudWatch:\n - **Métricas estándar** (servicios AWS como EC2) vs **métricas custom**.\n - Uso del **CloudWatch Agent**:\n - Necesario para métricas del **sistema operativo** (CPU detallada, disco/filesystem).\n - Envío de **logs locales** (ej.: `access.log` de Nginx) a **CloudWatch Logs**.\n- Alarmas:\n - Estados: **OK**, **ALARM**, **INSUFFICIENT_DATA**.\n - Conceptos: *evaluation period*, *datapoints to alarm*.\n- Métricas desde logs:\n - **Metric Filter** para contar eventos (ej.: incrementar al detectar **errores 500**).\n - A partir de la métrica → **Alarma** → notificación (SNS → email).\n- Namespace y dimensiones:\n - **Namespace** agrupa métricas.\n - **Dimension** (*par clave-valor*) **categoriza**; *métrica + dimensión* puede generar “una métrica distinta”.\n- Resolución y retención:\n - **Detailed monitoring en EC2**: 1 min vs 5 min.\n - Las métricas **no se borran**, pero **pierden resolución** con el tiempo (agregación).\n\n## Puntos clave 2 — AWS CloudTrail: auditoría de la cuenta AWS\n- CloudTrail registra y permite auditar **actividad sobre la cuenta**:\n - Registra **todas las llamadas a la API** (vía consola, CLI, SDK).\n - Responde preguntas tipo:\n - *“¿Quién creó esta EC2?”*\n - *“¿Quién cambió este Security Group?”*\n - *“¿Quién ha hecho login en la consola?”*\n- Importante:\n - **No** monitoriza eventos *dentro* de una instancia (eso se cubre con logs/agent).\n - Enfocado a **auditoría**, **control** y *trazabilidad* de acciones.\n\n## Puntos clave 3 — Tipos de eventos en CloudTrail\n- **Management events**\n - Operaciones del *control plane* (alto nivel):\n - Crear recursos: EC2, S3 bucket, RDS, IAM, Security Groups, etc.\n- **Data events**\n - Operaciones sobre datos/recursos:\n - En S3: `GetObject`, `PutObject`, `DeleteObject`\n - En Lambda: *invocaciones*\n - En DynamoDB: operaciones sobre items\n- Ejemplo (estructura típica del evento)\n - Identidad: `userIdentity`\n - Acción: `eventName`\n - Contexto: `awsRegion`, timestamp\n - Detalle:\n - `requestParameters` (qué se pidió)\n - `responseElements` (resultado)\n\n## Puntos clave 4 — Retención y almacenamiento: por defecto vs Trail\n- Por defecto, CloudTrail permite consultar:\n - **Últimos 90 días**\n - Solo **Management events**\n- Para retener y almacenar más allá de lo básico:\n - Crear un **Trail** y elegir destino:\n - **Amazon S3**\n - **CloudTrail Lake**\n\n## Puntos clave 5 — Consultas sobre logs: Amazon Athena sobre S3\n- CloudTrail en S3:\n - Logs en **JSON** (normalmente comprimidos), organizados por estructura temporal (año/mes/día).\n- **Amazon Athena**\n - Permite lanzar consultas tipo **SQL** directamente sobre datos en **S3**.\n - Enfoque *serverless*: no requiere ETL previo para “cargar a una BD”.\n- Consideraciones de coste\n - Athena cobra por **datos escaneados**.\n - Recomendación operativa en el texto:\n - Evitar consultas que escaneen todo el histórico (ej.: un `SELECT *` sin acotar).\n - Usar **particionado/índices** (por fecha/rango temporal) para reducir escaneo.\n\n## Puntos clave 6 — CloudTrail Lake: alternativa a S3\n- CloudTrail Lake:\n - En lugar de S3, permite enviar eventos a un **data lake gestionado**.\n - Usa formato columnar (*orientado a Big Data*), optimizando consultas por columnas.\n- Ventajas mencionadas:\n - Menos configuración operativa (*más “seguro out-of-the-box”*).\n - Query más eficientes/rápidas (por formato orientado a consulta).\n- Limitaciones destacadas:\n - Retención incluida: **7 años** (si se requiere más, habría que plantear **migración** a otro storage).\n - Opciones de permisos/ACL más limitadas que S3 (según el comentario del profesor).\n\n## Puntos clave 7 — Costes (visión general del texto)\n- CloudTrail (consulta de historial de 90 días de management events): **gratis**.\n- Trails a S3:\n - **Primera copia** de management events: **gratis**.\n - Copias adicionales: coste por volumen de eventos (ej.: *por cada 100k eventos*).\n - Data events: coste adicional (por volumen de eventos).\n - **+ coste S3** por almacenamiento.\n- CloudTrail Insights:\n - Analiza patrones y detecta anomalías en llamadas a la API.\n - Tiene coste adicional por volumen analizado.\n- CloudTrail Lake:\n - Coste ligado a **ingesta + análisis** y con retención (7 años) incluida según tabla comentada.\n\n## Puntos clave 8 — AWS Config (introducción breve)\n- Servicio orientado a **gobernanza y cumplimiento**:\n - Evalúa configuraciones de recursos y cambios en tiempo real.\n - Permite definir **reglas** y disparar acciones (remediación, alertas, bloqueo lógico).\n- Incluye:\n - *Compliance packs* (reglas predefinidas tipo “best practices”).\n - *Snapshots* de configuración e histórico (almacenables en S3).\n\n## Puntos clave 9 — Trazas en microservicios (avance conceptual)\n- Problema en microservicios:\n - Métricas y logs por servicio → difícil correlación para una petición de usuario de extremo a extremo.\n- **Traza (trace)**\n - Representa una petición completa y su propagación entre servicios.\n - Se compone de **spans** (segmentos de trabajo) con jerarquía (padre/hijo).\n- Instrumentación\n - Añadir librerías al código para interceptar llamadas (ej.: HTTP) y crear spans.\n - Propagación de contexto:\n - Se inyecta un **header** con el *trace id* entre microservicios.\n - Un **agente** recolecta y envía datos al sistema de visualización/almacenamiento.\n- Métricas orientadas a experiencia de usuario (mencionadas):\n - **Rate**, **Error**, **Duration**.\n\n## Puntos clave 10 — Laboratorio propuesto: auditoría con CloudTrail + notificación con EventBridge\n- Escenario:\n - Se despliega una “API de gatitos” en un contenedor.\n - Tras un tiempo, el coste de AWS se dispara.\n - Objetivo: **descubrir qué ha pasado** usando **CloudTrail** (sin mirar el código fuente).\n- Pasos principales descritos:\n - Crear/activar un **Trail** y mandar eventos a **S3**.\n - Usar **Athena** para consultar los logs en S3.\n - Desplegar la infraestructura con **Terraform** (repositorio proporcionado).\n - Identificar acciones “extra” realizadas por la aplicación (causa del coste).\n- Mitigación/alertado:\n - Configurar **EventBridge** para detectar eventos (ej.: creación/arranque de EC2).\n - Enviar notificación a **Slack** mediante **webhook** (HTTP POST).\n\n## Conclusiones/Próximos pasos\n- **CloudTrail** es la base para auditar *quién hizo qué* en AWS, en qué momento y con qué parámetros; es distinto de monitorizar el sistema operativo o la app.\n- Para análisis práctico:\n - Persistir eventos en **S3** y consultarlos con **Athena** habilita investigación forense y auditoría sin montar infra adicional.\n - Considerar **CloudTrail Lake** cuando se busca simplificar operación y optimizar consultas/retención gestionada.\n- Próximos pasos recomendados en la sesión:\n - Completar el **laboratorio** (detección de la causa del coste y alertas a Slack).\n - Continuar el miércoles con el servicio de trazas y la parte de *instrumentación* (y herramientas asociadas).
